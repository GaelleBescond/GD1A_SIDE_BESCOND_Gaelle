<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Wedding Quest</title>
            <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js">

            </script>
        <style type="text/css"> body { margin: 0; }</style>
    </head>
    <body>
        <script type="text/javascript">

            var config = {
                type: Phaser.AUTO,
                width: 640, height: 640,
                physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 500 },
                    debug: true,
                }},
                scene: {preload: preload, create: create, update: update }
            };



            function preload(){
                //chargement sky
                this.load.image("sky","assets/Sky.png")
                //chargement surface
                this.load.image("surface","assets/Surface.png")
                //chargement background
                this.load.image("background","assets/Background.png")
                //chargement foreground              
                this.load.image("foreground","assets/Cascade.png")
                // chargement tuiles de jeu
                this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");
                // chargement de la carte
                this.load.tilemapTiledJSON("carte", "assets/map.json");  
                //chargement étoile
                this.load.image('star', 'assets/star.png');

                //chargement du personnage
                
                this.load.spritesheet("img_perso", "assets/Perso_Design_Jeu_Alpha.png", {
                    frameWidth: 263,
                    frameHeight: 541
                }); 
                               
                //this.load.spritesheet('persoX','assets/perso.png',
                //    { frameWidth: 24, frameHeight: 64 });
            }
            
            new Phaser.Game(config);
            var player; // désigne le sprite du joueur 
            var clavier; //commandes
            var gameOver = false; //fin de partie
            var toucheLock = true; //verrouillage des commandes
            var wallJumpLock = true; //cooldown du wall jump
            var gameplayLevel = 0; // niveau de gameplay, débloquage de nouvelles mécaniques
            var idleGaze = false; //Orientation du regard quand le personnage est immobile, selon la dernière direction

            /*//////////////////////////////////////////////////////////////////////////

                            FUNCTION CREATE

            //////////////////////////////////////////////////////////////////////////*/
            function create() {
                //chargement des essentiels                
                    //chargement du ciel  
                        this.skyparallax = this.add.tileSprite(0, 0, 1600, 1600, "sky");
                        this.skyparallax.setOrigin(0, 0);   
                        this.skyparallax.setScrollFactor(0.2);

                    //chargement du background        
                       this.add.image(800, 800, "background");
                    //chargement de la surface   
                       this.add.image(800, 800, "surface");
                       
                       
                    // chargement de la carte
                      const carteDuNiveau = this.add.tilemap("carte");
                    // chargement du jeu de tuiles
                      const tileset = carteDuNiveau.addTilesetImage("tuiles_de_jeu","Phaser_tuilesdejeu");  
                    
                //chargement des calques
                    // chargement du calque calque_terrain
                       const calque_terrain = carteDuNiveau.createLayer("terrain", tileset);  
                       calque_terrain.setCollisionByProperty({ estSolide: true }); 

                    // chargement du calque calque_Dangers
                        const calque_Dangers = carteDuNiveau.createLayer("dangers_passifs", tileset);
                        calque_Dangers.setCollisionByProperty({ estSolide: true }); 

                    // chargement du calque calque_plateformes
                        const calque_plateformes = carteDuNiveau.createLayer("platforms",tileset);  
                        calque_plateformes.setCollisionByProperty({ estSolide: true });

                    //Apparition du joueur
                    player = this.physics.add.sprite(50, 200, 'img_perso'); 
                        player.setCollideWorldBounds(true);
                    // ajout d'une collision entre le joueur et les calques plateformes, terrain, dangers
                        this.physics.add.collider(player, calque_terrain);  
                        this.physics.add.collider(player, calque_Dangers);        
                        this.physics.add.collider(player, calque_plateformes); 

                    //chargement du calque_cosmetics
                        const calque_cosmetics = carteDuNiveau.createLayer("Cosmetics",tileset);  
                                        
                    //chargement du calque_cosmetics_pratique_3
                    const calque_cosmetics_3 = carteDuNiveau.createLayer("Cosmetics_Pratique_3",tileset);  

                    //chargement du calque_cosmetics_pratique_2
                    const calque_cosmetics_2 = carteDuNiveau.createLayer("Cosmetics_Pratique_2",tileset);  

                    //chargement du calque_cosmetics_pratique
                    const calque_cosmetics_1 = carteDuNiveau.createLayer("Cosmetics_Pratique",tileset);
                   
                   
                   
                    //chargement du calque_mechanics
                        bonus_mechanics = this.physics.add.group();
                        calque_new_mechanics = carteDuNiveau.getObjectLayer("new_mechanics");
                        //Overlap des bonus
                        calque_new_mechanics.objects.forEach( calque_new_mechanics =>{
                            const mechanichiante = bonus_mechanics.create( calque_new_mechanics.x + 16, calque_new_mechanics.y +16, "star").body.setAllowGravity(false);});
                            this.physics.add.overlap(bonus_mechanics, player, collectStar);

                //chargement du foreground
                this.add.image(800, 800, "foreground");  

                //chargement du calque_cosmetics_Cascade
                const calque_cosmetics_cascade = carteDuNiveau.createLayer("Cosmetics_Cascade",tileset);
                // Display de texte
                    title=this.add.text(160,260,'Your beloved one is on the other side',{fontSize:'16px',fill:'#000'}).setScrollFactor(0);

                //Intégration des commandes
                    clavier = this.input.keyboard.createCursorKeys(); 

                //Caméra
                    // redimensionnement du monde avec les dimensions calculées via tiled
                    this.physics.world.setBounds(0, 0, 1600, 1600);
                    //  ajout du champs de la caméra de taille identique à celle du monde
                    this.cameras.main.setBounds(0, 0, 1600, 1600);
                    // ancrage de la caméra sur le joueur
                    this.cameras.main.startFollow(player);
                    this.cameras.main.setZoom(1.5);
            }
            
            /*//////////////////////////////////////////////////////////////////////////
            
                            FUNCTIONS FOR THE GAME
            
            /////////////////////////////////////////////////////////////////////////*/
            //Interaction murs
                //Largement optimisable en fusionnant les deux fonctions de wallgrab/jump
                //déverouillage des touches
                    function lockTouches(){
                    toucheLock = true;
                }
                //Fonction Wall grab left
                    function wallGrabLeft(){
                        if (gameplayLevel >=3){
                            player.setVelocityY(-35);
                            player.setVelocityX(0);
                        } else{
                            player.setVelocityY(5);
                            player.setVelocityX(0);
                        }
                    // Wall jump gauche
                    if (clavier.up.isDown && wallJumpLock){
                        //bloquage des touches pour éviter interférence 
                        toucheLock = false;
                        //début cooldown wall jump    
                        wallJumpLock = false;
                        //paramètres d'éjection     
                        player.setVelocityY(-300);
                        player.setVelocityX(150);
                        //fin bloquage des touches          
                        setTimeout(lockTouches, 200)
                        //fin du cooldown wall jump
                        setTimeout(lockWallJump, 2000)
                    }
                }
                //Fonction Wall grab right
                    function wallGrabRight(){
                        if (gameplayLevel >=3){
                            player.setVelocityY(-35);
                            player.setVelocityX(0);
                        } else{
                            player.setVelocityY(-5);
                            player.setVelocityX(0);
                        }
                    // Wall jump droite
                    if (clavier.up.isDown &&  wallJumpLock){
                        toucheLock = false;
                        wallJumpLock = false;
                        player.setVelocityY(-300);
                        player.setVelocityX(-150);
                        setTimeout(lockTouches, 200)
                        setTimeout(lockWallJump, 2000)
                    }
                }
                //déverouillage du wall jump
                    function lockWallJump(){
                    wallJumpLock = true;
                }
                    
            //Amélioration du kit de déplacement
                function collectStar(player, bonus_mechanics){
                    bonus_mechanics.disableBody(true, true); // l’étoile disparaît
                    gameplayLevel += 1; //augmente le niveau de mécanique de 1
                }
                    //Ajouter le nouveau texte indiquant le bonus ramassé

            
            //Dangers, feuilles vertes
                function hitLeaf(player, leaf){
                    this.physics.pause();
                    player.setTint(0xff0000);
                    player.anims.play('turn');
                    gameOver = true;
                }    


            /*//////////////////////////////////////////////////////////////////////////

                            FUNCTION UPDATE

            //////////////////////////////////////////////////////////////////////////*/
            function update(){
                //Parallaxe
                //this.sky.tilePositionX = this.myCam.scrollX * .3;
                //déplacement
                //droite
                if (clavier.right.isDown && toucheLock) {
                    player.setVelocityX(200);
                    idleGaze = true;
                } 
                    //gauche
                else if (clavier.left.isDown && toucheLock) {
                    player.setVelocityX(-200);
                    idleGaze = false;
                } 
                else if (clavier.left.isUp && clavier.right.isUp && toucheLock){
                    //idle
                    player.setVelocityX(0);
                        if (idleGaze){

                        }
                        else {

                        }

                } 
                
                //Saut
                if (clavier.up.isDown && player.body.blocked.down && (gameplayLevel >= 1)) {
                    player.setVelocityY(-300);
                }  
                //glide
                if (clavier.up.isDown && player.body.touching.down) {
                    player.setVelocityY(-100);
                }  

                //Interaction mur
                    // Wall grab gauche
                    if (clavier.left.isDown && player.body.blocked.left && (gameplayLevel >= 2)){
                        wallGrabLeft();
                    }
                    // Wall grab droite
                    else if (clavier.right.isDown && player.body.blocked.right && (gameplayLevel >= 2)){
                        wallGrabRight();
                    }

            }
            /*A faire:
                Créer des plateformes fines?
                Refaire le niveau selon circulation
                Ajuster les sauts et wall jumps
                Animer la mariée
                    Saut en l'air (1 sprite x2)
                    Chute (1 sprite x2)
                    Course (4 sprites x2)
                    Accrochage mur (1 sprite x2)
                    Idle (1 sprite x2, vanilla regarde déjà vers la gauche)
                Ajouter vie (robe intacte => déchirée)
                Ajouter display Cooldown Wall jump
                Ajouter physique dans liquide
                Ajouter dangers
                */
                
        </script>
    </body>
</html>
